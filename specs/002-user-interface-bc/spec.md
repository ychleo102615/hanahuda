# Feature Specification: User Interface BC - Domain Layer

**Feature Branch**: `002-user-interface-bc`
**Created**: 2025-11-09
**Status**: Draft
**Input**: User description: "根據 @doc/readme.md @doc/frontend/user-interface/domain.md @doc/shared/ @doc/quality/ 開發 user-interface BC"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 卡片邏輯驗證與視覺回饋 (Priority: P1)

玩家在遊戲介面中選擇手牌時,系統必須即時顯示哪些場牌可以配對,並提供視覺提示(如高亮邊框)。當玩家打出手牌後,系統應正確判斷配對結果,並透過動畫顯示卡片移動到獲得區。

**Why this priority**: 這是遊戲核心互動的基礎,沒有正確的配對邏輯和即時反饋,玩家無法正常進行遊戲。這是 MVP 的絕對必要功能。

**Independent Test**: 可透過建立一個簡單的測試介面,顯示 8 張場牌和 8 張手牌,選擇任意手牌後驗證:
1. 場牌中同月份的牌被高亮顯示
2. 點擊高亮的場牌後,兩張牌正確移動到獲得區
3. 無同月份場牌時,顯示「無配對」提示

**Acceptance Scenarios**:

1. **Given** 場上有松(1月)かす牌 `0141`、梅(2月)種牌 `0221`,玩家手牌有松(1月)光牌 `0111`, **When** 玩家選擇手牌 `0111`, **Then** 場上 `0141` 被高亮顯示,`0221` 保持正常狀態
2. **Given** 場上有 3 張芒(8月)牌 `0841`, `0842`, `0843`,玩家手牌有芒(8月)光牌 `0811`, **When** 玩家選擇手牌 `0811`, **Then** 場上所有 3 張芒牌同時高亮,系統提示「請選擇一張配對」
3. **Given** 場上無任何 3 月的牌,玩家手牌有櫻(3月)光牌 `0311`, **When** 玩家選擇手牌 `0311`, **Then** 無場牌高亮,系統顯示「無配對,卡片將放置場上」
4. **Given** 玩家選擇手牌 `0111` 並成功配對 `0141`, **When** 配對完成, **Then** 兩張卡片以動畫形式移動到玩家獲得區,場牌從 8 張變為 7 張
5. **Given** 玩家嘗試打出不在手牌中的卡片 ID `9999`, **When** 系統驗證, **Then** 返回錯誤「無效的卡片」,操作被阻止

---

### User Story 2 - 役種即時檢測與進度提示 (Priority: P1)

玩家每次獲得卡片後,系統應即時檢測是否形成役種(如五光、赤短、豬鹿蝶等),並在 UI 上顯示已形成的役種和分數。同時提供役種進度提示,例如「距離赤短還差 1 張」、「已收集豬鹿蝶中的豬和鹿」。

**Why this priority**: 役種檢測是遊戲計分的核心,玩家需要即時知道自己的役種狀態才能做出 Koi-Koi 決策。這直接影響遊戲策略和使用者體驗。

**Independent Test**: 建立一個測試環境,手動設定玩家已獲得牌區的卡片:
1. 設定玩家已獲得 3 張赤短(`0131`, `0231`, `0331`),驗證系統顯示「赤短(5點)」
2. 設定玩家已獲得 2 張赤短(`0131`, `0231`),驗證系統顯示「距離赤短還差 1 張」
3. 設定玩家已獲得全部 5 張光牌,驗證系統顯示「五光(15點)」並正確計算總分

**Acceptance Scenarios**:

1. **Given** 玩家已獲得牌區有松赤短 `0131`、梅赤短 `0231`, **When** 玩家再獲得櫻赤短 `0331`, **Then** 系統檢測到「赤短」役種,UI 顯示「赤短(5點)」,並觸發役種特效
2. **Given** 玩家已獲得萩豬 `0721`、紅葉鹿 `1021`, **When** 玩家再獲得牡丹蝶 `0621`, **Then** 系統檢測到「豬鹿蝶」役種,UI 顯示「豬鹿蝶(5點)」
3. **Given** 玩家已獲得 4 張光牌(松鶴、櫻幕、芒月、桐鳳凰), **When** 再獲得柳小野道風(雨), **Then** 系統檢測到「五光(15點)」而非「雨四光(8點)」,因為五光分數更高
4. **Given** 玩家已獲得 5 張短冊, **When** 再獲得第 6 張短冊, **Then** 系統顯示「短冊(2點)」(基礎 1 點 + 額外 1 點)
5. **Given** 玩家已獲得 2 張赤短, **When** UI 顯示役種進度, **Then** 顯示「赤短進度: 2/3,還差 1 張(櫻赤短)」

---

### User Story 3 - 對手狀態分析與威脅評估 (Priority: P2)

玩家在遊戲過程中,系統應分析對手已獲得的牌,計算對手可能形成的役種,並提供威脅度評估(低、中、高、極高)。例如,當對手距離五光還差 1 張時,系統應顯示「警告:對手距離五光僅差 1 張」。

**Why this priority**: 這是進階功能,幫助新手玩家理解對手的策略意圖,提升遊戲體驗。雖然重要,但不是 MVP 的絕對必要功能,可在核心功能完成後實作。

**Independent Test**: 設定對手已獲得牌區的卡片,驗證威脅評估邏輯:
1. 設定對手已獲得 4 張光牌(不含雨),驗證系統顯示「威脅度:極高 - 距離四光僅差 0 張」
2. 設定對手已獲得 2 張赤短,驗證系統顯示「威脅度:中 - 距離赤短還差 1 張」

**Acceptance Scenarios**:

1. **Given** 對手已獲得 4 張光牌(松鶴、櫻幕、芒月、桐鳳凰), **When** 系統分析對手狀態, **Then** 顯示「威脅度:極高 - 對手已形成四光(10點)」
2. **Given** 對手已獲得萩豬、紅葉鹿, **When** 系統分析, **Then** 顯示「威脅度:中 - 對手距離豬鹿蝶還差 1 張(牡丹蝶)」
3. **Given** 對手已獲得 9 張かす牌, **When** 系統分析, **Then** 顯示「威脅度:低 - 對手距離かす役(10張)還差 1 張」
4. **Given** 對手已獲得 3 張種牌、2 張短冊、5 張かす牌(無特定役種), **When** 系統分析, **Then** 顯示「威脅度:低 - 無明顯役種威脅」

---

### User Story 4 - 遊戲進度與分數差距提示 (Priority: P3)

系統應根據牌堆剩餘張數和手牌數,計算還能進行幾回合,並顯示進度條。同時分析與對手的分數差距,提供策略建議(激進/平衡/保守)。

**Why this priority**: 這是輔助功能,增強使用者體驗,但不影響核心遊戲流程。可作為 Post-MVP 功能實作。

**Independent Test**: 設定牌堆剩餘張數和雙方分數,驗證進度計算和策略建議:
1. 牌堆剩餘 10 張,手牌 4 張,驗證系統顯示「剩餘 5 回合,進度 79%」
2. 玩家分數 0,對手分數 15,驗證系統建議「策略:激進(落後 15 分)」

**Acceptance Scenarios**:

1. **Given** 牌堆剩餘 24 張(起始狀態), **When** 系統計算進度, **Then** 顯示「剩餘 12 回合,進度 0%」
2. **Given** 牌堆剩餘 2 張,手牌 1 張, **When** 系統計算, **Then** 顯示「剩餘 1 回合,進度 96%」
3. **Given** 玩家分數 20,對手分數 10, **When** 系統分析, **Then** 顯示「領先 10 分,建議策略:保守」
4. **Given** 玩家分數 5,對手分數 25, **When** 系統分析, **Then** 顯示「落後 20 分,建議策略:激進」

---

### Edge Cases

- **卡片 ID 格式錯誤**: 當系統接收到無效的卡片 ID(如 `"9999"`, `"abc"`, `"01"`)時,應返回明確錯誤訊息「無效的卡片 ID」,不應導致系統崩潰
- **空陣列處理**: 當場牌陣列為空、手牌陣列為空、已獲得牌陣列為空時,所有函數應正確處理並返回預期結果(如配對函數返回「無配對」)
- **役種衝突**: 當同時形成「四光」和「雨四光」時,系統應選擇分數更高的「四光(10點)」
- **多重配對**: 當手牌可與場上 2 張以上同月份的牌配對時,系統應等待玩家選擇,不自動決定
- **翻牌雙重配對**: 當翻開的牌堆牌可與場上 2 張牌配對時,系統應中斷流程,等待玩家選擇目標
- **邊界值**: 測試月份邊界(1 月、12 月)、類型邊界(光、種、短、かす)、索引邊界(1-4)
- **Unicode 處理**: 卡片顯示名稱包含日文字符(如「松鶴」、「小野道風」),應正確顯示與儲存

## Requirements *(mandatory)*

### Functional Requirements

#### 卡片核心邏輯 (P1 - 必須實作)

- **FR-001**: 系統必須能解析 MMTI 格式的卡片 ID(4 位字串),提取月份(01-12)、類型(1-4)、索引(1-4),並驗證格式合法性
- **FR-002**: 系統必須根據卡片 ID 返回卡片屬性,包含月份、類型名稱、點數、顯示名稱
- **FR-003**: 系統必須能按月份、類型、點數對卡片陣列進行分組與排序
- **FR-004**: 系統必須提供快速查詢卡片點數的功能(光牌 20 點、種牌 10 點、短冊 5 點、かす 1 點)

#### 配對驗證邏輯 (P1 - 必須實作)

- **FR-005**: 系統必須能判斷兩張牌是否可配對(月份相同為可配對)
- **FR-006**: 系統必須能從場牌陣列中找出所有可與指定手牌配對的場牌
- **FR-007**: 系統必須能區分「無配對」、「單一配對」、「多重配對(2張以上)」三種情況
- **FR-008**: 系統必須在發送命令前預先驗證操作合法性(如卡片不存在、月份不符),並返回具體錯誤原因
- **FR-009**: 系統必須驗證選擇的配對目標是否在可選列表中

#### 役種檢測邏輯 (P2 - 重要)

- **FR-010**: 系統必須根據玩家已獲得牌,即時檢測所有已形成的役種,包含:
  - 光牌系:五光(15點)、四光(10點)、雨四光(8點)、三光(6點)
  - 短冊系:赤短(5點)、青短(5點)、短冊(5張起算 1點,每多 1 張加 1 點)
  - 種牌系:豬鹿蝶(5點)、花見酒(3點)、月見酒(3點)、種(5張起算 1點,每多 1 張加 1 點)
  - かす系:かす(10張起算 1點,每多 1 張加 1 點)
- **FR-011**: 系統必須檢查特定役種是否形成(如檢查玩家是否達成「赤短」)
- **FR-012**: 系統必須計算役種進度,返回「需要的卡片」、「已獲得的卡片」、「缺少的卡片」列表
- **FR-013**: 系統必須識別並解決役種衝突(如「四光」與「雨四光」同時成立時,選擇分數更高的「四光」)
- **FR-014**: 系統必須計算當前總分,包含所有役種基礎分與 Koi-Koi 倍率

#### 對手分析邏輯 (P2 - 重要)

- **FR-015**: 系統必須分析對手已獲得牌,計算對手已形成的役種和可能形成的役種
- **FR-016**: 系統必須為對手狀態標示威脅等級(低、中、高、極高),標準如下:
  - 極高:已形成 10 分以上役種,或距離高分役種(五光、四光)僅差 1 張
  - 高:距離中等役種(赤短、青短、豬鹿蝶)僅差 1 張
  - 中:距離任何役種差 2 張
  - 低:無明顯役種威脅
- **FR-017**: 系統必須統計對手卡片類型分布(幾張光、幾張種、幾張短、幾張かす)

#### 遊戲進度計算 (P3 - 輔助功能)

- **FR-018**: 系統必須根據牌堆剩餘張數和手牌數計算剩餘回合數
- **FR-019**: 系統必須計算局進度百分比(0-100%)
- **FR-020**: 系統必須分析分數差距,判斷優勢狀態(領先、持平、落後)
- **FR-021**: 系統必須根據分數差距提供策略建議(激進、平衡、保守)

### 技術要求

- **TR-001**: 所有 Domain Layer 函數必須為純函數,無副作用,相同輸入保證相同輸出
- **TR-002**: Domain Layer 不得依賴任何框架(Vue、Pinia、UI 組件等)
- **TR-003**: 所有函數必須可獨立測試,無需 UI 環境
- **TR-004**: 卡片邏輯與配對驗證的單元測試覆蓋率必須達到 100%
- **TR-005**: 役種檢測的單元測試覆蓋率必須達到 100%,包含所有 12 種常用役種與衝突情況
- **TR-006**: 所有公開函數必須有 TypeScript 型別定義,避免使用 `any`
- **TR-007**: 所有錯誤情況必須返回明確的錯誤訊息,不得拋出未處理的異常

### Key Entities

- **Card (Value Object)**: 代表一張花札卡片
  - 屬性:卡片 ID(MMTI 格式)、月份(1-12)、類型(BRIGHT/ANIMAL/RIBBON/DREG)、點數(20/10/5/1)、顯示名稱
  - 不可變物件,建立後不可修改

- **YakuScore (Value Object)**: 代表一個役種與其分數
  - 屬性:役種類型(如 GOKO, AKATAN)、基礎分數
  - 不可變物件

- **MatchStatus (Value Object)**: 代表配對狀態
  - 屬性:狀態類型(NO_MATCH/SINGLE_MATCH/MULTIPLE_MATCHES)、可配對目標列表
  - 不可變物件

- **YakuProgress (Value Object)**: 代表役種進度
  - 屬性:役種類型、需要的卡片列表、已獲得的卡片列表、缺少的卡片列表、完成百分比
  - 不可變物件

- **ThreatLevel (Value Object)**: 代表對手威脅等級
  - 屬性:等級(LOW/MEDIUM/HIGH/CRITICAL)、威脅原因列表
  - 不可變物件

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 卡片 ID 解析與驗證功能在處理 48 張標準花札卡片時,100% 正確識別月份、類型、索引
- **SC-002**: 配對驗證邏輯在所有測試場景(無配對、單一配對、多重配對)中,100% 返回正確結果
- **SC-003**: 役種檢測在所有 12 種常用役種的測試用例中,100% 正確檢測,無誤報或漏報
- **SC-004**: 役種衝突解決邏輯在衝突情境(如四光 vs 雨四光)中,100% 選擇分數更高的役種
- **SC-005**: 所有 Domain Layer 函數的單元測試覆蓋率達到 100%(卡片邏輯、配對驗證、役種檢測)
- **SC-006**: 邊界值測試(無效卡片 ID、空陣列、極端值)100% 通過,無異常拋出
- **SC-007**: 所有純函數在相同輸入下,100 次執行結果完全一致(驗證無副作用)
- **SC-008**: 役種檢測效能在處理最大情境(玩家已獲得 24 張牌)時,單次檢測耗時小於 10 毫秒
- **SC-009**: TypeScript 型別檢查在嚴格模式下零錯誤,無 `any` 型別使用(特殊情況除外)
- **SC-010**: 所有公開函數具備完整的 JSDoc 文檔,說明參數、返回值、範例

### User Experience Outcomes

- **SC-011**: 玩家選擇手牌後,可配對的場牌高亮顯示延遲小於 50 毫秒(即時反饋)
- **SC-012**: 役種形成時,UI 顯示役種名稱與分數的延遲小於 100 毫秒
- **SC-013**: 對手威脅評估結果在 UI 上清晰可見,玩家無需額外操作即可理解威脅狀態
- **SC-014**: 新手玩家在第一次遊戲時,能透過役種進度提示(如「距離赤短還差 1 張」)理解遊戲目標,無需查閱規則文檔

## Assumptions

1. **卡片 ID 格式一致性**: 假設所有卡片 ID 均遵循 MMTI 格式(4 位字串),前端與後端使用相同編碼規則,詳見 `protocol.md`
2. **伺服器權威原則**: Domain Layer 的驗證邏輯僅用於前端即時反饋與 UI 提示,最終遊戲狀態與規則驗證由後端負責
3. **12 種常用役種範圍**: MVP 階段僅實作 12 種常用役種(詳見 `game-rules.md`),特殊役種(如手四、月見)暫不實作
4. **JavaScript 執行環境**: 假設前端在現代瀏覽器環境(支援 ES2020+)中執行,無需考慮 IE11 相容性
5. **役種分數固定**: 假設所有役種的基礎分數固定不變(如五光恆為 15 點),不支援自訂規則
6. **單一玩家視角**: Domain Layer 僅處理單一玩家的視角邏輯(我的手牌、我的已獲得牌),對手資訊來自伺服器事件
7. **效能要求**: 假設遊戲在一般桌面/筆電環境執行,單次役種檢測必須在 10 毫秒內完成
8. **Unicode 支援**: 假設執行環境完整支援 Unicode,日文字符(如「小野道風」)可正確顯示與處理
9. **不可變數據結構**: 所有 Domain Layer 函數假設輸入參數不會被修改,返回新物件而非修改原有物件
10. **測試框架**: 使用 Vitest 作為單元測試框架,假設開發環境已正確安裝與設定

## Dependencies

- **數據契約**: 依賴 `doc/shared/data-contracts.md` 定義的 Card、YakuScore 等數據結構
- **通訊協議**: 依賴 `doc/shared/protocol.md` 定義的卡片 ID 編碼規則(MMTI 格式)
- **遊戲規則**: 依賴 `doc/shared/game-rules.md` 定義的役種規則、分數計算規則
- **測試策略**: 遵循 `doc/quality/testing-strategy.md` 定義的測試覆蓋率目標與測試工具
- **效能指標**: 遵循 `doc/quality/metrics.md` 定義的前端效能目標

## Out of Scope

以下項目**不在**本次 User Interface BC - Domain Layer 開發範圍內:

1. **UI 組件實作**: 卡片顯示組件、動畫效果、樣式設計等屬於 Presentation Layer,不在 Domain Layer 範圍
2. **狀態管理**: Pinia Stores、Vue Composables 等屬於 Application Layer 或 Adapter Layer
3. **API 通訊**: REST API 呼叫、SSE 事件接收屬於 Adapter Layer
4. **Local Game BC**: 離線單機遊戲引擎(完整遊戲流程、發牌邏輯、對手策略)為獨立 BC,不在本次範圍
5. **後端邏輯**: 所有後端 Domain Layer、Application Layer、Adapter Layer 邏輯不在前端 BC 範圍
6. **特殊役種**: 手四、月見、親權等特殊役種不在 MVP 範圍,Post-MVP 才實作
7. **自訂規則**: 可調整役種分數、啟用/停用特定役種等功能不在 MVP 範圍
8. **多語言支援**: 僅支援繁體中文介面,日文、英文等多語言為 Post-MVP 功能
9. **效能優化進階**: Web Worker、Memoization 等進階效能優化技術不在 MVP 範圍,除非測試顯示效能不足
10. **E2E 測試**: 本次僅負責 Domain Layer 單元測試,E2E 測試屬於整合測試範疇

## Notes

- 本規格基於 Clean Architecture 原則,Domain Layer 必須完全獨立於框架與外部依賴
- 所有函數設計為純函數,便於測試與維護
- 前端驗證邏輯僅用於即時 UI 反饋,**伺服器擁有最終驗證權**
- 役種檢測邏輯必須與後端保持一致,建議定期比對測試用例
- TypeScript 型別定義應與 `data-contracts.md` 保持同步
- 單元測試應覆蓋所有邊界情況,包含無效輸入、空陣列、極端值
